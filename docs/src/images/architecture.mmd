graph TB
    %% Utility Layer (Left)
    subgraph UtilSupport["Utility Layer"]
        LOGGER[Logger<br/>────────<br/>DEBUG/INFO/WARN<br/>ERROR/FATAL]
        UNITS[Units<br/>────────<br/>ParseColWidth<br/>ParseRowHeight<br/>PxToColWidth]
        CONFIG[BaseConfig<br/>────────<br/>Logger<br/>DefaultRowHeight<br/>DefaultColumnWidth]
    end
    
    %% Input Layer
    subgraph InputLayer["Input Layer"]
        GXL[GXL Template<br/>.gxl file]
        DATA[Data File<br/>.json/.yaml]
    end
    
    %% Command Layer
    subgraph CommandLayer["Command Layer"]
        CLI[CLI Tool<br/>goxcel command]
        ROOT[Root Command<br/>Cobra CLI]
        GENCMD[Generate Command]
        FMTCMD[Format Command]
    end
    
    %% Controller Layer
    subgraph ControllerLayer["Controller Layer"]
        GENCTRL[GenerateController<br/>RunGenerate<br/>InitGenerateCmd]
        FMTCTRL[FormatController<br/>InitFormatCmd]
    end
    
    %% Usecase Layer
    subgraph UsecaseLayer["Usecase Layer"]
        BOOKIF["&lt;&lt;interface&gt;&gt;<br/>BookUsecase<br/>────────<br/>Render(ctx, gxl, data)"]
        BOOKIMPL[bookUsecase struct<br/>────────<br/>conf: BaseConfig<br/>logger: Logger<br/>sheet: sheetRenderer<br/>xlsx: XlsxRepository]
        FMTIF["&lt;&lt;interface&gt;&gt;<br/>FormatUsecase<br/>────────<br/>Format(path)"]
        FMTIMPL[DefaultFormatUsecase<br/>────────<br/>conf: BaseConfig<br/>logger: Logger<br/>gxl: GxlRepository]
        SHEETRDR[sheetRenderer struct<br/>internal<br/>────────<br/>RenderSheet<br/>renderGrid<br/>expandGridRows]
        CELLHLP[cellHelper struct<br/>internal<br/>────────<br/>ExpandMustache<br/>InferCellType<br/>ParseTypeHint]
    end
    
    %% Repository Layer
    subgraph RepositoryLayer["Repository Layer"]
        GXLIF["&lt;&lt;interface&gt;&gt;<br/>GxlRepository<br/>────────<br/>ReadGxl(path)<br/>FormatGxl(path)"]
        GXLIMPL[gxlRepository struct<br/>────────<br/>Conf: BaseConfig<br/>logger: Logger]
        XLSXIF["&lt;&lt;interface&gt;&gt;<br/>XlsxRepository<br/>────────<br/>CreateBook/Sheet/Cell<br/>UpdateBook/Sheet/Cell<br/>DeleteBook/Sheet<br/>ClearCell"]
        XLSXIMPL[xlsxRepository struct<br/>────────<br/>Conf: BaseConfig<br/>logger: Logger]
    end
    
    %% Output Layer
    subgraph OutputLayer["Output Layer"]
        XLSX[Excel File<br/>.xlsx output]
        FMTGXL[Formatted GXL<br/>pretty-printed]
    end
    
    %% Model Layer (Right)
    subgraph ModelSupport["Model Layer"]
        GXLMODEL[GXL Models<br/>────────<br/>SheetTag, GridTag<br/>RowTag, CellTag<br/>ForTag, IfTag]
        XLSXMODEL[XLSX Models<br/>────────<br/>Book, Sheet, Cell<br/>CellType, Style<br/>MergeRange]
    end
    
    %% Invisible links to force vertical layout
    InputLayer ~~~ CommandLayer ~~~ ControllerLayer ~~~ UsecaseLayer ~~~ RepositoryLayer ~~~ OutputLayer
    
    %% Input Flow
    GXL --> CLI
    DATA --> CLI
    CLI --> ROOT
    ROOT --> GENCMD
    ROOT --> FMTCMD
    
    %% Command to Controller
    GENCMD --> GENCTRL
    FMTCMD --> FMTCTRL
    
    %% Controller to Interface
    GENCTRL --> BOOKIF
    FMTCTRL --> FMTIF
    
    %% Interface Implementation
    BOOKIF -.implements.-> BOOKIMPL
    FMTIF -.implements.-> FMTIMPL
    GXLIF -.implements.-> GXLIMPL
    XLSXIF -.implements.-> XLSXIMPL
    
    %% Usecase Dependencies
    BOOKIMPL --> SHEETRDR
    SHEETRDR --> CELLHLP
    BOOKIMPL --> XLSXIF
    FMTIMPL --> GXLIF
    
    %% Usecase to Repository (vertical flow)
    BOOKIF --> GXLIF
    BOOKIF --> XLSXIF
    FMTIF --> GXLIF
    
    %% Repository to Output (vertical flow)
    GXLIF --> FMTGXL
    XLSXIF --> XLSX
    GXLIMPL --> FMTGXL
    XLSXIMPL --> XLSX
    
    %% Repository to Model
    GXLIMPL --> GXLMODEL
    XLSXIMPL --> XLSXMODEL
    SHEETRDR --> GXLMODEL
    CELLHLP --> XLSXMODEL
    
    %% Utility Dependencies
    CONFIG -.injected.-> BOOKIMPL
    CONFIG -.injected.-> FMTIMPL
    CONFIG -.injected.-> GXLIMPL
    CONFIG -.injected.-> XLSXIMPL
    LOGGER -.used by.-> BOOKIMPL
    LOGGER -.used by.-> FMTIMPL
    LOGGER -.used by.-> GXLIMPL
    LOGGER -.used by.-> XLSXIMPL
    UNITS -.used by.-> XLSXIMPL
    
    %% Styling
    classDef inputClass fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef commandClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef controllerClass fill:#ffe0b2,stroke:#e65100,stroke-width:2px
    classDef interfaceClass fill:#fff9c4,stroke:#f57f17,stroke-width:3px,stroke-dasharray: 5 5
    classDef implClass fill:#c8e6c9,stroke:#1b5e20,stroke-width:2px
    classDef internalClass fill:#b2dfdb,stroke:#004d40,stroke-width:2px
    classDef repoInterfaceClass fill:#ffccbc,stroke:#bf360c,stroke-width:3px,stroke-dasharray: 5 5
    classDef repoImplClass fill:#ffe0b2,stroke:#e65100,stroke-width:2px
    classDef modelClass fill:#f8bbd0,stroke:#880e4f,stroke-width:2px
    classDef utilClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef outputClass fill:#b2dfdb,stroke:#00695c,stroke-width:2px
    classDef backgroundClass fill:#e0e0e0,stroke:#616161,stroke-width:2px
    
    class GXL,DATA inputClass
    class CLI,ROOT,GENCMD,FMTCMD commandClass
    class GENCTRL,FMTCTRL controllerClass
    class BOOKIF,FMTIF interfaceClass
    class BOOKIMPL,FMTIMPL implClass
    class SHEETRDR,CELLHLP internalClass
    class GXLIF,XLSXIF repoInterfaceClass
    class GXLIMPL,XLSXIMPL repoImplClass
    class GXLMODEL,XLSXMODEL modelClass
    class LOGGER,UNITS,CONFIG utilClass
    class XLSX,FMTGXL outputClass
    
    style UtilSupport fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px
    style ModelSupport fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px


